<!DOCTYPE html>
<html lang="en">
<!--<![endif]-->
<!-- BEGIN HEAD -->

<head>
    <meta charset="utf-8"/>
    <title>IDStack</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta content="width=device-width, initial-scale=1" name="viewport"/>
    <meta content="IDStack | The common protocol for document verification built on Blockchain" name="description"/>
    <meta content="www.idstack.one" name="author"/>
    <!-- BEGIN GLOBAL MANDATORY STYLES -->
    <link href="http://fonts.googleapis.com/css?family=Open+Sans:400,300,600,700&subset=all" rel="stylesheet"
          type="text/css"/>
    <link href="assets/global/plugins/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css"/>
    <link href="assets/global/plugins/simple-line-icons/simple-line-icons.min.css" rel="stylesheet" type="text/css"/>
    <link href="assets/global/plugins/bootstrap/css/bootstrap.min.css" rel="stylesheet" type="text/css"/>
    <link href="assets/global/plugins/bootstrap-switch/css/bootstrap-switch.min.css" rel="stylesheet" type="text/css"/>
    <!-- END GLOBAL MANDATORY STYLES -->
    <!-- BEGIN PAGE LEVEL PLUGINS -->
    <link href="assets/global/plugins/bootstrap-fileinput/bootstrap-fileinput.css" rel="stylesheet" type="text/css"/>
    <link href="assets/global/plugins/bootstrap-table/bootstrap-table.min.css" rel="stylesheet" type="text/css"/>
    <link href="assets/global/plugins/bootstrap-toastr/toastr.min.css" rel="stylesheet" type="text/css" />

    <!-- END PAGE LEVEL PLUGINS -->
    <!-- BEGIN THEME GLOBAL STYLES -->
    <link href="assets/global/css/components-md.min.css" rel="stylesheet" id="style_components" type="text/css"/>
    <link href="assets/global/css/plugins-md.min.css" rel="stylesheet" type="text/css"/>
    <!-- END THEME GLOBAL STYLES -->
    <!-- BEGIN THEME LAYOUT STYLES -->
    <link href="assets/layout/css/layout.min.css" rel="stylesheet" type="text/css"/>
    <link href="assets/layout/css/themes/blue.min.css" rel="stylesheet" type="text/css" id="style_color"/>
    <link href="assets/layout/css/custom.min.css" rel="stylesheet" type="text/css"/>
    <!-- END THEME LAYOUT STYLES -->
    <link rel="shortcut icon" href="assets/favicon.png"/>
</head>
<!-- END HEAD -->

<body class="page-header-fixed page-sidebar-closed-hide-logo page-container-bg-solid page-sidebar-closed page-md">
<!-- BEGIN HEADER -->
<div id="header"></div>
<!-- END HEADER -->
<!-- BEGIN HEADER & CONTENT DIVIDER -->
<div class="clearfix"></div>
<!-- END HEADER & CONTENT DIVIDER -->
<!-- BEGIN CONTAINER -->
<div class="page-container">
    <!-- BEGIN SIDEBAR -->
    <div id="sidebar"></div>
    <!-- END SIDEBAR -->
    <!-- BEGIN CONTENT -->
    <div class="page-content-wrapper">
        <!-- BEGIN CONTENT BODY -->
        <div class="page-content">
            <!-- BEGIN PAGE HEAD-->
            <div class="page-head">
                <!-- BEGIN PAGE TITLE -->
                <div class="page-title">
                    <h1>Document view
                        <small>View Document content, signatures and scores</small>
                    </h1>

                </div>
                <!-- END PAGE TITLE -->
                <!-- BEGIN PAGE BASE CONTENT -->

                <div class="row" id="document_array">
                    <div class="col-md-12" id="column_0" style="display: none">
                        <div class="portlet light portlet-fit portlet-form ">
                            <div class="portlet-title">

                                <div class="form-group">

                                </div>
                            </div>
                            <div class="portlet-body">
                                <div id="template"></div>
                            </div>
                        </div>

                        <div class="portlet light ">
                            <div class="portlet-title">
                                <div class="caption">
                                    <i class="icon-pencil font-green"></i>
                                    <span class="caption-subject font-dark bold uppercase">Signatures</span>
                                </div>

                            </div>
                            <div class="portlet-body">
                                <!-- BEGIN: Signature list -->
                                <div class="mt-comments" id="signature_list">

                                    <!-- BEGIN: Signature template -->
                                    <script id="signature_template" type="text/html">
                                        <div class="mt-comment mt-element-ribbon" id="signature-0">
                                            <div class="ribbon ribbon-vertical-left ribbon-shadow ribbon-color-primary uppercase">
                                                <div class="ribbon-sub ribbon-bookmark"></div>
                                                <i class="fa fa-pencil-square-o"></i>
                                            </div>
                                            <div class="mt-comment-body">
                                                <div class="mt-comment-info">
                                                    <span class="mt-comment-author">${id}</span>
                                                    <!--<span class="mt-comment-author">${name}</span>-->

                                                    <!--<span class="mt-comment-date" id="signed_date">${signed_date}</span>-->
                                                </div>
                                                <!--<div class="mt-comment-text" id="email"> ${email}</div>-->
                                                <!--<div class="mt-comment-text" id="type"> ${type}</div>-->
                                                <!--<div class="mt-comment-text" id="expire_date"> ${expire_date}</div>-->
                                                <div class="mt-comment-details">
                                                    <!--<span class="mt-comment-status mt-comment-status-approved"-->
                                                          <!--id="validity">${validity}</span>-->
                                                    <ul class="mt-comment-actions">
                                                        <li>
                                                            <a href="#">More</a>
                                                        </li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                    </script>
                                    <!-- END: Signature list -->

                                </div>
                                <!-- END: Signature list -->
                            </div>
                        </div>

                        <div class="portlet light">
                            <div class="portlet-title">
                                <div class="caption">
                                    <i class="icon-graph"></i>
                                    <span class="caption-subject bold uppercase font-dark">Individual Score</span>
                                    <span class="caption-helper font-dark">Individual Score for the Document.</span>
                                </div>

                            </div>
                            <div class="portlet-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h4 id="confidence-score">%</h4>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div>
                    <div class="portlet light" id="correlation_portlet" style="display: none">
                        <div class="portlet-title">
                            <div class="caption">
                                <i class="icon-graph"></i>
                                <span class="caption-subject bold uppercase font-dark">Correlation document score</span>
                                <span class="caption-helper font-dark">Correlation Score for multiple Documents.</span>
                            </div>
                        </div>
                        <div class="portlet-body">
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="table-scrollable" id="correlation_table">

                                        <script id="correlation_table_template" type="text/x-jquery-tmpl">
                                            <table class="table table-hover table-bordered">
                                                <thead >
                                                <tr>
                                                    <th rowspan="2" class="text-center col-md-1"> Attribute</th>
                                                    <th rowspan="2" class="text-center col-md-2"> Correlation Score</th>
                                                    {{each name.values}}
                                                    <th colspan="2" class="text-center"> Document ${$index + 1}</th>
                                                    {{/each}}
                                                    <!--<th colspan="2" class="text-center"> Document 2</th>-->
                                                    <!--<th colspan="2" class="text-center"> Document 3</th>-->
                                                </tr>
                                                <tr>
                                                    {{each name.values}}
                                                    <th class="col-md-2 "> Attribute Value</th>
                                                    <th class="col-md-1">Attribute Score</th>
                                                    {{/each}}
                                                </tr>
                                                </thead>
                                                <tbody>
                                                <tr>
                                                    <th> Name</th>
                                                    <th>
                                                        <div class="easy-pie-chart">
                                                            <div class="number visits" data-percent="${name.avgScore}">
                                                                <span>+${name.avgScore}</span>%
                                                            </div>
                                                        </div>
                                                    </th>
                                                    {{each name.values}}
                                                    <td> ${name.values[$index].text}</td>
                                                    <td><span class="label label-primary"> ${name.values[$index].score}% </span></td>
                                                    {{/each}}
                                                </tr>
                                                <tr>
                                                    <th>Address</th>
                                                    <th>
                                                        <div class="easy-pie-chart">
                                                            <div class="number visits" data-percent="${address.avgScore}">
                                                                <span>+${address.avgScore}</span>%
                                                            </div>
                                                        </div>
                                                    </th>
                                                    {{each address.values}}
                                                    <td> ${address.values[$index].text}</td>
                                                    <td><span class="label label-primary"> ${address.values[$index].score}% </span></td>
                                                    {{/each}}
                                                </tr>
                                                <tr>
                                                    <th>Date of Birth</th>
                                                    <th>
                                                        <div class="easy-pie-chart">
                                                            <div class="number visits" data-percent="${dob.avgScore}">
                                                                <span>+${dob.avgScore}</span>%
                                                            </div>
                                                        </div>
                                                    </th>
                                                    {{each dob.values}}
                                                    <td> ${dob.values[$index].text}</td>
                                                    <td><span class="label label-primary"> ${dob.values[$index].score}% </span></td>
                                                    {{/each}}
                                                </tr>
                                                <tr>
                                                    <th>Gender</th>
                                                    <th>
                                                        <div class="easy-pie-chart">
                                                            <div class="number visits" data-percent="${gender.avgScore}">
                                                                <span>+${gender.avgScore}</span>%
                                                            </div>
                                                        </div>
                                                    </th>
                                                    {{each gender.values}}
                                                    <td> ${gender.values[$index].text}</td>
                                                    <td><span class="label label-primary"> ${gender.values[$index].score}% </span></td>
                                                    {{/each}}
                                                </tr>
                                                <tr>
                                                    <th>NIC</th>
                                                    <th>
                                                        <div class="easy-pie-chart">
                                                            <div class="number visits" data-percent="${nic.avgScore}">
                                                                <span>+${nic.avgScore}</span>%
                                                            </div>
                                                        </div>
                                                    </th>
                                                    {{each nic.values}}
                                                    <td> ${nic.values[$index].text}</td>
                                                    <td><span class="label label-primary"> ${nic.values[$index].score}% </span></td>
                                                    {{/each}}
                                                </tr>
                                                </tbody>
                                            </table>
                                        </script>
                                    </div>

                                </div>
                            </div>
                        </div>

                    </div>
                    <!-- END PAGE BASE CONTENT -->
                </div>
            </div>
            <!-- END PAGE HEAD-->
        </div>
        <!-- END CONTENT BODY -->
    </div>
    <!-- END CONTENT -->
</div>
<!-- END CONTAINER -->

    <!--<script type="text/javascript" src="https://ajax.aspnetcdn.com/ajax/jQuery/jquery-3.0.0.min.js"></script>-->

    <!-- Start wrapper for jquery script imports  -->
    <script>if (typeof module === 'object') {
        window.module = module;
        module = undefined;
    }</script>

    <script type="text/javascript" src="assets/global/plugins/jquery.min.js"></script>

    <!-- End wrapper for jquery script imports -->
    <script>if (window.module) module = window.module;</script>

    <script>
        var request_id;
        var varProperties;
        var docListResponse;
        var docCount;
        var jsonDocResponse ;
        var confidenceResponse=[];
        var correlationResponse ;


        $(function () {
            $("#header").load("layout/header.html");
            $("#sidebar").load("layout/sidebar.html");
            $.getJSON("properties.json", function(json) {
                varProperties = json;
                request_id = getUrlParameter("request_id");
                getDocstoreByRequest(request_id);
                getCorrelationByRequest(request_id);
            });


        });


        function loadView() {
            if (docCount >= 4) {
                toastr.warning('You have exceed the maximum number of documents');
                return;
            }
            for (var i = 0; i < docCount; i++) {
                var source = $('#column_0');
                var clone = source.clone();
                clone.removeAttr('style');
                clone.attr('id', 'column_' + i);
                clone.removeClass('col-md-12').addClass('col-md-' + 12 / docCount);

                console.log(docListResponse.files_list[i].json);
                getMRDoc(docListResponse.files_list[i].json,clone);

            }

        }

        function loadContentView(clone,MRDoc) {
            setTimeout(function () {
                clone.find('div#document').loadJSON(MRDoc.content);
                try {
                    clone.find('div#document').loadJSON(MRDoc.content.name);
                    clone.find('div#document').loadJSON(MRDoc.content.address);
                }catch(err) {
                    //
                }
            },1)
        }

        function loadSignatureView(clone,MRDoc) {
            $("#signature_template").tmpl(MRDoc.extractor).appendTo(clone.find("#signature_list"));
            for (var j = 0; j < MRDoc.validators.length; j++) {
                $("#signature_template").tmpl(MRDoc.validators[j]).appendTo(clone.find("#signature_list"));
            }
        }


        // web service calls

        function getConfidenceByUrl(url,clone) {
            var form = new FormData();
            form.append("json_url", url);

            var settings = {
                "async": true,
                "crossDomain": true,
                "url": "http://"+varProperties.relyingparty.host+"/api-relyingparty/"+varProperties.relyingparty.apiVersion+"/"+varProperties.relyingparty.apiKey+"/confidence/url",
                "method": "POST",
                "headers": {
                    "Authorization": "Basic " + btoa(varProperties.relyingparty.userName + ":" + varProperties.relyingparty.password)
                },
                "processData": false,
                "contentType": false,
                "mimeType": "multipart/form-data",
                "data": form
            }

            $.ajax(settings).done(function (response) {
                response = JSON.parse(response);
                console.log(response);
                clone.find("#confidence-score").prepend(response.score);
            }).fail(function () {
                clone.find("#confidence-score").prepend(response.score);
            });
        }

        function getCorrelationByRequest(requestId) {
            var form = new FormData();
            form.append("request_id", requestId);

            var settings = {
                "async": true,
                "crossDomain": true,
                "url": "http://"+varProperties.relyingparty.host+"/api-relyingparty/"+varProperties.relyingparty.apiVersion+"/"+varProperties.relyingparty.apiKey+"/correlation/request",
                "method": "POST",
                "headers": {
                    "Authorization": "Basic " + btoa(varProperties.relyingparty.userName + ":" + varProperties.relyingparty.password)
                },
                "processData": false,
                "contentType": false,
                "mimeType": "multipart/form-data",
                "data": form
            }

            $.ajax(settings).done(function (response) {
                response = JSON.parse(response);
                console.log(response);
                $("#correlation_table_template").tmpl(response).appendTo("#correlation_table");
                $("#correlation_portlet").removeAttr('style');
            });
        }

        function getDocstoreByRequest(requestId) {
            var form = new FormData();
            form.append("request_id", requestId);

            var settings = {
                "async": true,
                "crossDomain": true,
                "url": "http://"+varProperties.relyingparty.host+"/api-relyingparty/"+varProperties.relyingparty.apiVersion+"/"+varProperties.relyingparty.apiKey+"/getdocstore/request",
                "method": "POST",
                "headers": {
                    "Authorization": "Basic " + btoa(varProperties.relyingparty.userName + ":" + varProperties.relyingparty.password)
                },
                "processData": false,
                "contentType": false,
                "mimeType": "multipart/form-data",
                "data": form
            }

            $.ajax(settings).done(function (response) {
                response = JSON.parse(response);
                console.log(response);
                docCount=response.files_list.length;
                console.log(docCount);
                docListResponse=response;
                loadView();
            });
        }

        function getMRDoc(url,clone) {
            var form = new FormData();
            form.append("json_url", "http://139.59.74.146:8080/idstack/relyingparty/docs/info@avix.lk/a7444ebf-1cf3-490f-bea4-21cdb1d7c926/passport/1.json");

            var settings = {
                "async": true,
                "crossDomain": true,
                "url": "http://"+varProperties.relyingparty.host+"/api-relyingparty/"+varProperties.relyingparty.apiVersion+"/"+varProperties.relyingparty.apiKey+"/getdocstore/url",
                "method": "POST",
                "headers": {
                    "Authorization": "Basic " + btoa(varProperties.relyingparty.userName + ":" + varProperties.relyingparty.password)
                },
                "processData": false,
                "contentType": false,
                "mimeType": "multipart/form-data",
                "data": form
            }

            $.ajax(settings).done(function (response) {
                response = JSON.parse(response).json[0];
                console.log(response);
                clone.find("#template").load("doc_templates/view/"+response.meta_data.document_type+".html",loadContentView(clone,response) );
                loadSignatureView(clone,response);
                getConfidenceByUrl(url,clone);
                $('#document_array').append(clone);
            });
        }

    </script>


    <!-- BEGIN CORE PLUGINS -->

    <script src="assets/global/plugins/bootstrap/js/bootstrap.min.js" type="text/javascript"></script>
    <script src="assets/global/plugins/js.cookie.min.js" type="text/javascript"></script>
    <script src="assets/global/plugins/jquery-slimscroll/jquery.slimscroll.min.js" type="text/javascript"></script>
    <script src="assets/global/plugins/jquery.blockui.min.js" type="text/javascript"></script>
    <script src="assets/global/plugins/bootstrap-switch/js/bootstrap-switch.min.js" type="text/javascript"></script>
    <!-- END CORE PLUGINS -->
    <!-- BEGIN PAGE LEVEL PLUGINS -->
    <script src="assets/global/plugins/bootstrap-fileinput/bootstrap-fileinput.js" type="text/javascript"></script>
    <script src="https://cdn.rawgit.com/kevindb/jquery-load-json/v1.3.3/dist/jquery.loadJSON.min.js"
            integrity="sha384-fG4z44FEBJnIevyzvSDobSmVTsO/oVsxNvKcUl7bO1ihWYDPg2QI83Xi+7wSBzap"
            crossorigin="anonymous"></script>
    <script src="assets/global/plugins/bootstrap-table/bootstrap-table.min.js" type="text/javascript"></script>
    <script src="assets/global/plugins/bootstrap-toastr/toastr.min.js" type="text/javascript"></script>


    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script src="assets/global/plugins/jquery-knob/js/jquery.knob.js" type="text/javascript"></script>
    <script src="assets/global/plugins/jquery-easypiechart/jquery.easypiechart.min.js" type="text/javascript"></script>
    <script src="assets/global/plugins/jquery-tmpl/jquery.tmpl.min.js" type="text/javascript"></script>


    <!-- END PAGE LEVEL PLUGINS -->
    <!-- BEGIN THEME GLOBAL SCRIPTS -->
    <script src="assets/global/scripts/app.min.js" type="text/javascript"></script>

    <!-- END THEME GLOBAL SCRIPTS -->
    <!-- BEGIN PAGE LEVEL SCRIPTS -->
    <script src="assets/pages/scripts/table-bootstrap.js" type="text/javascript"></script>
    <script src="assets/pages/scripts/components-knob-dials.min.js" type="text/javascript"></script>
    <script src="assets/custom/scripts/url-paser.js" type="text/javascript" ></script>
    <!-- END PAGE LEVEL SCRIPTS -->


    <!-- BEGIN THEME LAYOUT SCRIPTS -->
    <script src="assets/layout/scripts/layout.min.js" type="text/javascript"></script>
    <script src="assets/layout/scripts/demo.min.js" type="text/javascript"></script>
    <script src="assets/layout/global/scripts/quick-sidebar.min.js" type="text/javascript"></script>
    <script src="assets/layout/global/scripts/quick-nav.min.js" type="text/javascript"></script>
    <!-- END THEME LAYOUT SCRIPTS -->

</body>

</html>