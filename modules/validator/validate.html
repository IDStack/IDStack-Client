<!DOCTYPE html>
<!DOCTYPE html>
<html lang="en">
<!--<![endif]-->
<!-- BEGIN HEAD -->

<head>
    <meta charset="utf-8"/>
    <title>IDStack</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta content="width=device-width, initial-scale=1" name="viewport"/>
    <meta content="IDStack | The common protocol for document verification built on Blockchain" name="description"/>
    <meta content="www.idstack.one" name="author"/>
    <!-- BEGIN GLOBAL MANDATORY STYLES -->
    <link href="http://fonts.googleapis.com/css?family=Open+Sans:400,300,600,700&subset=all" rel="stylesheet"
          type="text/css"/>
    <link href="../../assets/global/plugins/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css"/>
    <link href="../../assets/global/plugins/simple-line-icons/simple-line-icons.min.css" rel="stylesheet"
          type="text/css"/>
    <link href="../../assets/global/plugins/bootstrap/css/bootstrap.min.css" rel="stylesheet" type="text/css"/>
    <link href="../../assets/global/plugins/bootstrap-switch/css/bootstrap-switch.min.css" rel="stylesheet"
          type="text/css"/>
    <!-- END GLOBAL MANDATORY STYLES -->
    <!-- BEGIN PAGE LEVEL PLUGINS -->
    <link href="../../assets/global/plugins/bootstrap-datepicker/css/bootstrap-datepicker3.min.css" rel="stylesheet"
          type="text/css"/>
    <link href="../../assets/global/plugins/bootstrap-fileinput/bootstrap-fileinput.css" rel="stylesheet"
          type="text/css"/>

    <link rel="stylesheet"
          href="../../assets/global/plugins/bootstrap-material-datetimepicker/css/bootstrap-material-datetimepicker.css"/>
    <link href='http://fonts.googleapis.com/css?family=Roboto:400,500' rel='stylesheet' type='text/css'>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="../../assets/global/plugins/bootstrap-toastr/toastr.min.css" rel="stylesheet" type="text/css"/>
    <!-- END PAGE LEVEL PLUGINS -->
    <!-- BEGIN THEME GLOBAL STYLES -->
    <link href="../../assets/global/css/components-md.min.css" rel="stylesheet" id="style_components" type="text/css"/>
    <link href="../../assets/global/css/plugins-md.min.css" rel="stylesheet" type="text/css"/>
    <!-- END THEME GLOBAL STYLES -->
    <!-- BEGIN THEME LAYOUT STYLES -->
    <link href="../../assets/layout/css/layout.min.css" rel="stylesheet" type="text/css"/>
    <link href="../../assets/layout/css/themes/blue.min.css" rel="stylesheet" type="text/css" id="style_color"/>
    <link href="../../assets/layout/css/custom.min.css" rel="stylesheet" type="text/css"/>
    <!-- END THEME LAYOUT STYLES -->
    <link rel="shortcut icon" href="../../assets/favicon.png"/>
</head>
<!-- END HEAD -->

<body class="page-header-fixed page-sidebar-closed-hide-logo page-container-bg-solid page-sidebar-closed page-md">
<!-- BEGIN HEADER -->
<div class="page-header navbar navbar-fixed-top">
    <!-- BEGIN HEADER INNER -->
    <div class="page-header-inner">
        <!-- BEGIN LOGO -->
        <div class="page-logo bg-red bg-font-red">
            <div class="menu-toggler sidebar-toggler">
                <!-- DOC: Remove the above "hide" to enable the sidebar toggler button on header -->
            </div>
        </div>

        <!-- END LOGO -->
        <!-- BEGIN PAGE ACTIONS -->
        <!-- DOC: Remove "hide" class to enable the page header actions -->
        <div class="page-actions">
            <a href="../home/main.html">
                <img src="../../assets/logo-small.png" alt="logo" class="logo-default"/> </a>
            <div class="btn-group">
                <a class="btn btn-link disabled font-white" style="background-color: transparent;">
                    <small> Common Protocol for Document Verification</small>
                </a>
                <!--<span class="hidden-sm hidden-xs">idStack <small> Common Protocol for Document Verification </small></span>&nbsp;-->
            </div>
        </div>
        <!-- END PAGE ACTIONS -->
        <!-- BEGIN PAGE TOP -->
        <div class="page-top bg-purple-studio">
            <!-- BEGIN TOP NAVIGATION MENU -->
            <div class="top-menu m-grid-col-md-6">
                <ul class="nav navbar-nav pull-right">
                    <!-- BEGIN NOTIFICATION DROPDOWN -->
                    <li class="dropdown dropdown-extended dropdown-notification" id="header_notification_bar">
                        <h3 class="font-white bold uppercase" onclick="window.location.assign('dashboard.html')">
                            Validator</h3>
                    </li>
                    <!-- END NOTIFICATION DROPDOWN -->
                </ul>
            </div>
            <!-- END TOP NAVIGATION MENU -->
        </div>
        <!-- END PAGE TOP -->
    </div>
    <!-- END HEADER INNER -->
</div>
<!-- END HEADER -->
<!-- BEGIN HEADER & CONTENT DIVIDER -->
<div class="clearfix"></div>
<!-- END HEADER & CONTENT DIVIDER -->
<!-- BEGIN CONTAINER -->
<div class="page-container">
    <!-- BEGIN SIDEBAR -->
    <div id="sidebar"></div>
    <!-- END SIDEBAR -->
    <!-- BEGIN CONTENT -->
    <div class="page-content-wrapper">
        <!-- BEGIN CONTENT BODY -->
        <div class="page-content">
            <!-- BEGIN PAGE HEAD-->
            <div class="page-head">
                <!-- BEGIN PAGE TITLE -->
                <div class="page-title">
                    <h3>Data Validation
                        <small> validate data from document in order to make it into machine readable format</small>
                    </h3>
                </div>
                <!-- END PAGE TITLE -->
            </div>
            <!-- END PAGE HEAD-->
            <!-- BEGIN PAGE BASE CONTENT -->
            <div class="row">
                <div class="col-md-6">
                    <div class="tabbable-line boxless tabbable-reversed">
                        <ul class="nav nav-tabs">
                            <li class="active">
                                <a href="#tab_0" data-toggle="tab" id="tab_template"> </a>
                            </li>
                        </ul>
                        <div class="tab-content">
                            <div class="tab-pane active" id="tab_0">
                                <div class="portlet light portlet-fit portlet-form ">
                                    <div class="portlet-body">
                                        <!-- BEGIN CONTENT FORM-->
                                        <div id="form_template"></div>
                                        <!-- END CONTENT FORM-->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="portlet light portlet-fit portlet-form">
                        <div class="portlet-title">
                            <div class="caption">
                                <i class="icon-pencil font-green"></i>
                                <span class="caption-subject font-dark bold uppercase">Signatures</span>
                            </div>

                        </div>
                        <div class="portlet-body">
                            <!-- BEGIN: Signature list -->
                            <div class="mt-comments" id="signature_list">
                                <script id="signature_template" type="text/html">
                                    <div class="mt-comment mt-element-ribbon signature-block" id="${id}-signature">
                                        <div class="ribbon ribbon-vertical-left ribbon-shadow ribbon-color-primary uppercase">
                                            <div class="ribbon-sub ribbon-bookmark"></div>
                                            <i class="fa fa-pencil-square-o"></i>
                                        </div>
                                        <div class="mt-comment-body">
                                            <div class="mt-comment-info">
                                                <span class="mt-comment-author">${cert_details.CN}</span>
                                                <span class="mt-comment-date">${cert_details.EMAILADDRESS}</span>
                                            </div>
                                            <div class="mt-comment-text"> ${cert_details.OU}</div>
                                            <div class="mt-comment-details">
                                                <span class="mt-comment-status">${cert_details.O}</span>
                                                <ul class="mt-comment-actions">
                                                    <li>
                                                        <a href="#" class="signature-more-button" id="${id}-signature-more-button">More</a>
                                                    </li>
                                                </ul>
                                            </div>
                                        </div>
                                        <!--<div class="mt-comment-body">-->
                                        <!--<div class="mt-comment-info">-->
                                        <!--<span class="mt-comment-author">${id}</span>-->
                                        <!--&lt;!&ndash;<span class="mt-comment-author">${name}</span>&ndash;&gt;-->

                                        <!--&lt;!&ndash;<span class="mt-comment-date" id="signed_date">${signed_date}</span>&ndash;&gt;-->
                                        <!--</div>-->
                                        <!--&lt;!&ndash;<div class="mt-comment-text" id="email"> ${email}</div>&ndash;&gt;-->
                                        <!--&lt;!&ndash;<div class="mt-comment-text" id="type"> ${type}</div>&ndash;&gt;-->
                                        <!--&lt;!&ndash;<div class="mt-comment-text" id="expire_date"> ${expire_date}</div>&ndash;&gt;-->
                                        <!--<div class="mt-comment-details">-->
                                        <!--&lt;!&ndash;<span class="mt-comment-status mt-comment-status-approved"&ndash;&gt;-->
                                        <!--&lt;!&ndash;id="validity">${validity}</span>&ndash;&gt;-->
                                        <!--<ul class="mt-comment-actions">-->
                                        <!--<li>-->
                                        <!--<a href="#">More</a>-->
                                        <!--</li>-->
                                        <!--</ul>-->
                                        <!--</div>-->
                                        <!--</div>-->
                                    </div>
                                </script>
                            </div>
                            <!-- END: Signature list -->
                            <div class="form-actions right">
                                <div class="row">
                                    <div class="col-md-12">
                                        <button id="saveBtn" type="button" class="btn green" onclick="getValidate()">
                                            Validate and Save
                                        </button>
                                    </div>
                                </div>
                                <br>
                                <div class="raw">
                                    <div class="col-md-12">
                                        <button id="mrfDownloadBtn" type="button" class="btn red display-hide"
                                                onclick="downloadMrf()">Signed MRF <i class="fa fa-download"></i>
                                        </button>
                                        <button id="pdfDownloadBtn" type="button" class="btn red display-hide"
                                                onclick="downloadPdf()">Signed PDF <i class="fa fa-download"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <!--<object id="pdf_viewer" width="620px" height="500px" data="" onerror=errorInPdfViewer()>-->
                    <!--</object>-->

                    <object id="pdf_viewer_obj" width="600px" height="500px" data="" onerror=errorInPdfViewer()>
                        <iframe id="pdf_viewer_iframe" src="" style="width:600px; height:500px;" frameborder="0">
                            This browser does not support PDFs. Please download the PDF to view it: <a
                                id="pdf_viewer_down" href="http://www.orimi.com/pdf-test.pdf">Download PDF</a>
                        </iframe>
                    </object>
                </div>
            </div>
        </div>
    </div>
    <!-- END CONTENT -->
</div>
<!-- END CONTAINER -->

<!-- Start wrapper for jquery script imports  -->
<script>if (typeof module === 'object') {
    window.module = module;
    module = undefined;
}</script>

<script type="text/javascript" src="../../assets/global/plugins/jquery.min.js"></script>

<!-- End wrapper for jquery script imports -->
<script>if (window.module) module = window.module;</script>

<script>
    var url;
    var json_url;
    var request_id;
    var docType;
    var formObject;
    var varProperties;
    var signedPdfUrl;
    var signedMrf;

    $(function () {
        App.startPageLoading({
            animate: true
        });
        // Load header and sidebar into DOM dynamically
        $("#sidebar").load("../../layout/sidebar.html");
        $('.datePicker').bootstrapMaterialDatePicker({
            time: false,
            clearButton: true
        });
        $.getJSON("../../properties.json", function (json) {
            varProperties = json;
        });
        request_id = getUrlParameter("request_id");
        json_url = getUrlParameter("json");
        docType = getUrlParameter("doctype");
        if (docType || 0 !== docType.length) {
            $("#tab_template").append(stringBeautify(docType));
            $("#form_template").load("../../doc_templates/validate/" + docType + ".html");

            setTimeout(function () {
                getContentByRequest();
            }, 1000);
        }
        else {
            App.stopPageLoading();
            console.log("define docType uri parameter");
        }


    });

    function showPDFbyURL() {
        //support pdf view in electron
        document.getElementById("pdf_viewer_obj").data = url;
        document.getElementById("pdf_viewer_iframe").src = "https://docs.google.com/viewer?url=" + url + "&embedded=true";
    }

    function saveJsonFile(json_doc) {
        var jsonString = JSON.stringify(json_doc, null, 4);
        var file = new File([jsonString], json_doc.meta_data.document_type + "-signed.json", {type: "text/json;charset=utf-8"});
        saveAs(file);
        $("#downloadBtn").removeClass("display-hide");
    }

    function errorInPdfViewer() {
        console.log("Enter a valid url or file for resource pdf");
        toastr.error("Enter a valid url or file for resource pdf.");
    }


    //Web service calls
    function getValidate() {
        App.startPageLoading({
            animate: true
        });
        var form = new FormData();
        form.append("request_id", request_id);
//        form.append("request_id", request_id);

        var settings = {
            "async": true,
            "crossDomain": true,
            "url": "http://" + varProperties.validator.host + "/api-validator/" + varProperties.validator.apiVersion + "/" + varProperties.validator.apiKey + "/sign/request",
            "method": "POST",
            "headers": {
                "authorization": "Basic " + btoa(varProperties.validator.userName + ":" + varProperties.validator.password)
            },
            "processData": false,
            "contentType": false,
            "mimeType": "multipart/form-data",
            "data": form
        }

        $.ajax(settings).done(function (response) {
            console.log(response);
            response = JSON.parse(response);
            if ("meta_data" in response) {
                signedMrf = response;
                $("#mrfDownloadBtn").removeClass("display-hide");
            }
            else {
                console.log(response.status);
                toastr.warning(response.status);
            }
        }).fail(function (jqXHR, error, errorThrown) {
            if (jqXHR.status && jqXHR.status == 400) {
                toastr.error(jqXHR.responseText);
            } else {
                toastr.error("Something went wrong");
            }
        }).always(function () {
            App.stopPageLoading();
        });

    }

    function getContentByRequest() {
        var form = new FormData();
        form.append("json_url", json_url);

        var settings = {
            "async": true,
            "crossDomain": true,
            "url": "http://" + varProperties.validator.host + "/api-validator/" + varProperties.validator.apiVersion + "/" + varProperties.validator.apiKey + "/getdoc/url",
            "method": "POST",
            "headers": {
                "authorization": "Basic " + btoa(varProperties.validator.userName + ":" + varProperties.validator.password)
            },
            "processData": false,
            "contentType": false,
            "mimeType": "multipart/form-data",
            "data": form
        }

        $.ajax(settings).done(function (response) {
            response = JSON.parse(response);
            console.log(response);
            url = response.pdf;
            showPDFbyURL();
            formObject = $("form#form_validate_" + docType);
            formObject.loadJSON(response.json.content);
            signedMrf = response;
            loadSignatureView();
            App.stopPageLoading();
        }).fail(function (jqXHR, error, errorThrown) {
            if (jqXHR.status && jqXHR.status == 400) {
                toastr.error(jqXHR.responseText);
            } else {
                toastr.error("Something went wrong");
            }
        });
    }

    function loadSignatureView() {
//        $("#signature_template").tmpl(signedMrf.extractor).appendTo($("#signature_list"));
//        for (var j = 0; j < signedMrf.validators.length; j++) {
//            $("#signature_template").tmpl(signedMrf.validators[j]).appendTo($("#signature_list"));
//        }
//        var newSign = JSON.parse(JSON.stringify(signedMrf.cert_details_list[0]));
//        newSign.id = "123456";
//        signedMrf.cert_details_list.push(newSign);
//
//        signedMrf.json.validators.push({id: newSign.id, signed_content: true, signed_signatures: ["3d67d817"]});
//        console.log(signedMrf.json.validators);

        for (var j = 0; j < signedMrf.cert_details_list.length; j++) {
            $("#signature_template").tmpl(signedMrf.cert_details_list[j]).appendTo($("#signature_list"));
        }
        $(".signature-more-button").each(function (i, obj) {
            var myId = $(this).attr("id").split("-")[0];
            $(this).mouseenter(function () {
                //check if I am extractor or content Signed
                if (signedMrf.json.extractor.id == myId) {
                    $("#form_template").addClass("bg-green");
                } else {
                    for (var i = 0; i < signedMrf.json.validators.length; i++) {
                        var validator = signedMrf.json.validators[i];
                        if (validator.id == myId) {
                            if (validator.signed_content) {
                                $("#form_template").addClass("bg-green");
                            }
                            for (var j = 0; j < validator.signed_signatures.length; j++) {

                                $("#" + validator.signed_signatures[j] + "-signature").addClass("bg-red");
                            }
                            break;
                        }
                    }
                }

            });
            $(this).mouseleave(function () {
                $("#form_template").removeClass("bg-green");
                $(".signature-block").removeClass("bg-red");
            });
        });
    }

    04045648786204



    function downloadMrf() {
        saveJsonFile(signedMrf);
    }


</script>

<!-- BEGIN CORE PLUGINS -->

<script src="../../assets/global/plugins/bootstrap/js/bootstrap.min.js" type="text/javascript"></script>
<script src="../../assets/global/plugins/js.cookie.min.js" type="text/javascript"></script>
<script src="../../assets/global/plugins/jquery-slimscroll/jquery.slimscroll.min.js" type="text/javascript"></script>
<script src="../../assets/global/plugins/jquery.blockui.min.js" type="text/javascript"></script>
<script src="../../assets/global/plugins/bootstrap-switch/js/bootstrap-switch.min.js" type="text/javascript"></script>
<!-- END CORE PLUGINS -->
<!-- BEGIN PAGE LEVEL PLUGINS -->
<script type="text/javascript" src="../../assets/global/plugins/moment.min.js"></script>
<script type="text/javascript"
        src="../../assets/global/plugins/bootstrap-material-datetimepicker/js/bootstrap-material-datetimepicker.js"></script>
<script type="text/javascript" src="../../assets/global/plugins/filesaverjs/filesaver.min.js"></script>
<script src="../../assets/global/plugins/bootstrap-datepicker/js/bootstrap-datepicker.min.js"
        type="text/javascript"></script>
<script src="../../assets/global/plugins/bootstrap-fileinput/bootstrap-fileinput.js" type="text/javascript"></script>
<script src="https://cdn.rawgit.com/kevindb/jquery-load-json/v1.3.3/dist/jquery.loadJSON.min.js"
        integrity="sha384-fG4z44FEBJnIevyzvSDobSmVTsO/oVsxNvKcUl7bO1ihWYDPg2QI83Xi+7wSBzap"
        crossorigin="anonymous"></script>
<script src="../../assets/global/plugins/jquery.blockui.min.js" type="text/javascript"></script>
<script src="../../assets/global/plugins/bootstrap-toastr/toastr.min.js" type="text/javascript"></script>
<script src="../../assets/global/plugins/jquery-tmpl/jquery.tmpl.min.js" type="text/javascript"></script>
<!-- END PAGE LEVEL PLUGINS -->
<!-- BEGIN THEME GLOBAL SCRIPTS -->
<script src="../../assets/global/scripts/app.min.js" type="text/javascript"></script>
<!-- END THEME GLOBAL SCRIPTS -->
<!-- BEGIN PAGE LEVEL SCRIPTS -->
<!--<script src="../../doc_templates/json/idstack-passport.js" type="text/javascript"></script>-->
<script src="../../assets/custom/scripts/url-paser.js" type="text/javascript"></script>
<script src="../../assets/custom/scripts/string-beautify.js" type="text/javascript"></script>

<!-- END PAGE LEVEL SCRIPTS -->
<!-- BEGIN THEME LAYOUT SCRIPTS -->
<script src="../../assets/layout/scripts/layout.min.js" type="text/javascript"></script>
<script src="../../assets/layout/scripts/demo.min.js" type="text/javascript"></script>
<script src="../../assets/layout/global/scripts/quick-sidebar.min.js" type="text/javascript"></script>
<script src="../../assets/layout/global/scripts/quick-nav.min.js" type="text/javascript"></script>
<!-- END THEME LAYOUT SCRIPTS -->


</body>

</html>

